# 个性化食谱管理系统概要设计文档

## 1. 文档概述

### 1.1 文档目的
本文档基于需求规格说明书，详细描述个性化食谱管理系统的系统架构、模块划分、关键类与函数设计、数据库设计以及API接口设计，为系统的详细设计和实现提供指导。

### 1.2 术语定义
- **食谱**：包含食材清单、烹饪步骤、营养成分等信息的完整菜谱
- **饮食禁忌**：用户不能食用的食材或需要避免的饮食类型（如素食、无麸质等）
- **营养成分**：食物中含有的卡路里、蛋白质、碳水化合物、脂肪等营养元素
- **AI生成**：通过调用阿里通义千问API自动生成食谱内容
- **FastAPI**：基于Python的现代、快速（高性能）的Web框架
- **SQLAlchemy**：Python SQL工具包和ORM框架
- **PostgreSQL**：开源关系型数据库

## 2. 系统架构设计

### 2.1 总体架构

```
+----------------+     +----------------+     +----------------+     +----------------+
|                |     |                |     |                |     |                |
|   React前端     |-----|  FastAPI后端   |-----|  PostgreSQL    |     |  阿里通义千问  |
|   (Web App)    |     |  (API服务)     |     |   数据库      |     |     API        |
|                |     |                |     |                |     |                |
+----------------+     +----------------+     +----------------+     +----------------+
```

### 2.2 分层架构设计

#### 2.2.1 前端架构

```
+----------------+     +----------------+     +----------------+     +----------------+
|                |     |                |     |                |     |                |
|  UI组件层      |-----|  业务逻辑层    |-----|  状态管理层    |-----|  API调用层     |
| (React组件)    |     | (业务逻辑函数)  |     | (Context/Redux)|     |  (Axios)       |
|                |     |                |     |                |     |                |
+----------------+     +----------------+     +----------------+     +----------------+
```

#### 2.2.2 后端架构

```
+----------------+     +----------------+     +----------------+     +----------------+
|                |     |                |     |                |     |                |
|  API路由层     |-----|  服务层        |-----|  数据访问层    |-----|  外部服务层    |
| (FastAPI路由)  |     | (业务逻辑实现)  |     | (SQLAlchemy ORM)|  | (千问API调用)  |
|                |     |                |     |                |     |                |
+----------------+     +----------------+     +----------------+     +----------------+
```

### 2.3 技术架构选型

| 分类 | 技术 | 版本 | 选型理由 |
|------|------|------|----------|
| 前端框架 | React | 18.x | 组件化开发，高效渲染，生态成熟 |
| 状态管理 | Redux Toolkit | 1.9.x | 集中式状态管理，简化Redux使用 |
| UI组件库 | Ant Design | 5.x | 丰富的组件，良好的中文支持 |
| HTTP客户端 | Axios | 1.4.x | 强大的HTTP请求库，支持拦截器 |
| 后端框架 | FastAPI | 0.100.x | 异步支持，自动生成API文档，性能优异 |
| 数据库ORM | SQLAlchemy | 2.0.x | 功能强大的Python ORM框架 |
| 数据库 | PostgreSQL | 15.x | 强大的关系型数据库，JSONB支持良好 |
| 认证 | JWT | - | 无状态认证，便于水平扩展 |
| 容器化 | Docker | - | 简化部署和环境一致性 |

## 3. 模块划分与功能描述

### 3.1 前端模块

| 模块名称 | 主要职责 | 核心组件 | 文件位置 |
|---------|---------|---------|----------|
| 认证模块 | 用户注册、登录、个人信息管理 | LoginForm、RegisterForm、Profile | src/modules/auth/ |
| 食谱生成模块 | 食材输入、饮食禁忌设置、食谱生成 | IngredientInput、RestrictionSelector、RecipeGenerator | src/modules/recipe-generator/ |
| 食谱展示模块 | 食谱列表、食谱详情、搜索功能 | RecipeList、RecipeCard、RecipeDetail、SearchBar | src/modules/recipe-display/ |
| 交互模块 | 收藏、评分、分享功能 | FavoriteButton、RatingStars、ShareModal | src/modules/interaction/ |
| 用户偏好模块 | 饮食偏好设置、历史记录查看 | PreferenceSettings、HistoryView | src/modules/preferences/ |

### 3.2 后端模块

| 模块名称 | 主要职责 | 核心文件 | 文件位置 |
|---------|---------|---------|----------|
| 认证模块 | 用户认证、授权、JWT管理 | auth.py、jwt_utils.py | app/api/auth/ |
| 食谱模块 | 食谱生成、搜索、详情查询 | recipe.py、recipe_service.py | app/api/recipes/ |
| 用户模块 | 用户信息、偏好管理 | user.py、user_service.py | app/api/users/ |
| 数据访问模块 | 数据库操作、模型定义 | models.py、database.py、schemas.py | app/core/ |
| AI服务模块 | 调用千问API、解析响应 | ai_client.py、recipe_parser.py | app/services/ |
| 营养分析模块 | 营养成分计算、分析 | nutrition_calculator.py | app/services/ |

## 4. 关键类与函数设计

### 4.1 前端关键组件

#### 4.1.1 IngredientInput 组件
```typescript
interface IngredientInputProps {
  ingredients: string[];
  onAddIngredient: (ingredient: string) => void;
  onRemoveIngredient: (index: number) => void;
}

function IngredientInput({ ingredients, onAddIngredient, onRemoveIngredient }: IngredientInputProps): JSX.Element {
  // 实现食材输入功能
}
```

#### 4.1.2 RecipeGenerator 组件
```typescript
interface RecipeGeneratorProps {
  ingredients: string[];
  restrictions: string[];
  preferences: RecipePreferences;
  onGenerate: () => Promise<void>;
  loading: boolean;
  error: string | null;
}

function RecipeGenerator({ ingredients, restrictions, preferences, onGenerate, loading, error }: RecipeGeneratorProps): JSX.Element {
  // 实现食谱生成功能
}
```

#### 4.1.3 RecipeDetail 组件
```typescript
interface RecipeDetailProps {
  recipeId: string;
}

function RecipeDetail({ recipeId }: RecipeDetailProps): JSX.Element {
  // 实现食谱详情展示
}
```

### 4.2 后端关键类与函数

#### 4.2.1 食谱生成服务
```python
class RecipeGeneratorService:
    def __init__(self, ai_client: QianWenClient, nutrition_calculator: NutritionCalculator):
        self.ai_client = ai_client
        self.nutrition_calculator = nutrition_calculator
    
    async def generate_recipes(self, ingredients: List[str], restrictions: List[str], preferences: Dict) -> List[Recipe]:
        # 调用AI API生成食谱
        # 解析响应
        # 计算营养成分
        # 返回结构化食谱
        pass
```

#### 4.2.2 阿里通义千问客户端
```python
class QianWenClient:
    def __init__(self, api_key: str, base_url: str):
        self.api_key = api_key
        self.base_url = base_url
    
    async def generate_content(self, prompt: str) -> str:
        # 调用千问API生成内容
        pass
    
    def build_recipe_prompt(self, ingredients: List[str], restrictions: List[str], preferences: Dict) -> str:
        # 构建食谱生成的prompt
        pass
```

#### 4.2.3 营养计算服务
```python
class NutritionCalculator:
    def __init__(self, ingredient_repository: IngredientRepository):
        self.ingredient_repository = ingredient_repository
    
    async def calculate_nutrition(self, ingredients_with_amounts: List[Dict]) -> NutritionInfo:
        # 根据食材列表和用量计算营养成分
        pass
    
    def get_nutrition_for_ingredient(self, ingredient_name: str, amount: float, unit: str) -> Dict:
        # 获取单个食材的营养信息
        pass
```

#### 4.2.4 用户服务
```python
class UserService:
    def __init__(self, user_repository: UserRepository):
        self.user_repository = user_repository
    
    async def create_user(self, username: str, email: str, password: str) -> User:
        # 创建新用户
        pass
    
    async def update_preferences(self, user_id: UUID, preferences: Dict) -> User:
        # 更新用户偏好
        pass
    
    async def get_user_favorites(self, user_id: UUID) -> List[Recipe]:
        # 获取用户收藏
        pass
```

## 5. 数据库设计

### 5.1 数据库表结构

#### 5.1.1 users 表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| user_id | UUID | PRIMARY KEY | 用户ID |
| username | VARCHAR(100) | UNIQUE NOT NULL | 用户名 |
| email | VARCHAR(255) | UNIQUE NOT NULL | 邮箱 |
| password_hash | VARCHAR(255) | NOT NULL | 哈希后的密码 |
| diet_preferences | JSONB | DEFAULT '{}' | 饮食偏好(JSON格式) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

#### 5.1.2 recipes 表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| recipe_id | UUID | PRIMARY KEY | 食谱ID |
| title | VARCHAR(255) | NOT NULL | 食谱标题 |
| description | TEXT | | 食谱描述 |
| ingredients | JSONB | NOT NULL | 食材列表(JSON格式) |
| steps | JSONB | NOT NULL | 烹饪步骤(JSON格式) |
| cooking_time | INTEGER | | 烹饪时间(分钟) |
| difficulty | VARCHAR(50) | | 难度等级 |
| nutrition_info | JSONB | | 营养信息(JSON格式) |
| image_url | VARCHAR(500) | | 图片URL |
| tags | JSONB | DEFAULT '[]' | 标签(JSON格式) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

#### 5.1.3 favorites 表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| favorite_id | UUID | PRIMARY KEY | 收藏记录ID |
| user_id | UUID | REFERENCES users(user_id) | 用户ID |
| recipe_id | UUID | REFERENCES recipes(recipe_id) | 食谱ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 收藏时间 |

#### 5.1.4 ratings 表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| rating_id | UUID | PRIMARY KEY | 评分记录ID |
| user_id | UUID | REFERENCES users(user_id) | 用户ID |
| recipe_id | UUID | REFERENCES recipes(recipe_id) | 食谱ID |
| score | INTEGER | CHECK (score BETWEEN 1 AND 5) | 评分(1-5) |
| comment | TEXT | | 评论内容 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 评分时间 |

#### 5.1.5 ingredients 表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| ingredient_id | UUID | PRIMARY KEY | 食材ID |
| name | VARCHAR(255) | UNIQUE NOT NULL | 食材名称 |
| nutrition_info | JSONB | NOT NULL | 营养信息(JSON格式) |
| unit | VARCHAR(50) | | 计量单位 |

### 5.2 数据库索引设计

| 索引名 | 表名 | 索引字段 | 索引类型 | 目的 |
|--------|------|----------|---------|------|
| idx_users_username | users | username | B-tree | 加速用户名查询 |
| idx_users_email | users | email | B-tree | 加速邮箱查询 |
| idx_recipes_title | recipes | title | B-tree | 加速食谱标题搜索 |
| idx_favorites_user_recipe | favorites | user_id, recipe_id | 复合索引 | 加速用户收藏查询 |
| idx_ratings_user_recipe | ratings | user_id, recipe_id | 复合索引 | 加速用户评分查询 |
| idx_ingredients_name | ingredients | name | B-tree | 加速食材名称查询 |
| idx_recipes_tags | recipes | tags | GIN | 加速标签查询 |

### 5.3 数据库关系图

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|     users      |-----|    favorites   |-----|    recipes     |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
         |                                            |
         |                                            |
         v                                            v
+----------------+                              +----------------+
|                |                              |                |
|    ratings     |------------------------------|   ingredients  |
|                |                              |                |
+----------------+                              +----------------+
```

## 6. API接口设计

### 6.1 认证相关接口

#### 6.1.1 用户注册
- **URL**: `/api/auth/register`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "username": "user1",
    "email": "user1@example.com",
    "password": "password123"
  }
  ```
- **响应**:
  ```json
  {
    "user_id": "uuid",
    "username": "user1",
    "email": "user1@example.com",
    "access_token": "jwt_token"
  }
  ```

#### 6.1.2 用户登录
- **URL**: `/api/auth/login`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "email": "user1@example.com",
    "password": "password123"
  }
  ```
- **响应**:
  ```json
  {
    "access_token": "jwt_token",
    "token_type": "bearer",
    "user": {
      "user_id": "uuid",
      "username": "user1",
      "email": "user1@example.com"
    }
  }
  ```

#### 6.1.3 获取当前用户信息
- **URL**: `/api/users/me`
- **方法**: `GET`
- **认证**: JWT Token
- **响应**:
  ```json
  {
    "user_id": "uuid",
    "username": "user1",
    "email": "user1@example.com",
    "diet_preferences": {}
  }
  ```

#### 6.1.4 更新用户饮食偏好
- **URL**: `/api/users/me/preferences`
- **方法**: `PUT`
- **认证**: JWT Token
- **请求体**:
  ```json
  {
    "diet_type": "vegetarian",
    "flavor_preference": "spicy",
    "allergies": ["peanuts", "shellfish"]
  }
  ```
- **响应**:
  ```json
  {
    "user_id": "uuid",
    "diet_preferences": {
      "diet_type": "vegetarian",
      "flavor_preference": "spicy",
      "allergies": ["peanuts", "shellfish"]
    }
  }
  ```

### 6.2 食谱相关接口

#### 6.2.1 生成食谱
- **URL**: `/api/recipes/generate`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "ingredients": ["鸡肉", "土豆", "胡萝卜"],
    "restrictions": ["无麸质", "低糖"],
    "preferences": {
      "cooking_time": "30分钟内",
      "difficulty": "简单"
    }
  }
  ```
- **响应**:
  ```json
  {
    "recipes": [
      {
        "recipe_id": "uuid",
        "title": "鸡肉炖土豆胡萝卜",
        "description": "健康美味的家常菜",
        "ingredients": [...],
        "steps": [...],
        "nutrition_info": {...}
      }
    ]
  }
  ```

#### 6.2.2 获取食谱列表
- **URL**: `/api/recipes`
- **方法**: `GET`
- **查询参数**: `page=1&limit=10&tags=健康,家常菜`
- **响应**:
  ```json
  {
    "total": 100,
    "page": 1,
    "limit": 10,
    "recipes": [
      {
        "recipe_id": "uuid",
        "title": "...",
        "image_url": "...",
        "cooking_time": 30,
        "difficulty": "简单"
      }
    ]
  }
  ```

#### 6.2.3 获取食谱详情
- **URL**: `/api/recipes/{recipe_id}`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "recipe_id": "uuid",
    "title": "...",
    "description": "...",
    "ingredients": [
      {
        "name": "鸡肉",
        "amount": 200,
        "unit": "克"
      }
    ],
    "steps": ["步骤1", "步骤2"],
    "nutrition_info": {
      "calories": 350,
      "protein": 25,
      "carbs": 20,
      "fat": 15
    },
    "average_rating": 4.5
  }
  ```

#### 6.2.4 搜索食谱
- **URL**: `/api/recipes/search`
- **方法**: `GET`
- **查询参数**: `query=鸡肉&cooking_time=30&difficulty=简单`
- **响应**:
  ```json
  {
    "total": 25,
    "recipes": [...] // 与食谱列表格式相同
  }
  ```

### 6.3 用户交互接口

#### 6.3.1 收藏食谱
- **URL**: `/api/recipes/{recipe_id}/favorite`
- **方法**: `POST`
- **认证**: JWT Token
- **响应**:
  ```json
  {
    "message": "Recipe favorited successfully",
    "favorite_id": "uuid"
  }
  ```

#### 6.3.2 取消收藏
- **URL**: `/api/recipes/{recipe_id}/favorite`
- **方法**: `DELETE`
- **认证**: JWT Token
- **响应**:
  ```json
  {
    "message": "Recipe unfavorited successfully"
  }
  ```

#### 6.3.3 评分食谱
- **URL**: `/api/recipes/{recipe_id}/rate`
- **方法**: `POST`
- **认证**: JWT Token
- **请求体**:
  ```json
  {
    "score": 5,
    "comment": "非常好吃！"
  }
  ```
- **响应**:
  ```json
  {
    "message": "Rating submitted successfully",
    "rating_id": "uuid"
  }
  ```

#### 6.3.4 获取用户收藏列表
- **URL**: `/api/users/me/favorites`
- **方法**: `GET`
- **认证**: JWT Token
- **查询参数**: `page=1&limit=10`
- **响应**:
  ```json
  {
    "total": 15,
    "page": 1,
    "limit": 10,
    "favorites": [
      {
        "recipe_id": "uuid",
        "title": "...",
        "image_url": "...",
        "favorited_at": "2024-01-01T12:00:00Z"
      }
    ]
  }
  ```

## 7. 系统集成与接口设计

### 7.1 前端与后端集成

- **API基础URL**: 前端配置统一的API基础URL，便于环境切换
- **请求拦截器**: 实现统一的请求头处理、认证信息添加
- **响应拦截器**: 统一错误处理、响应格式转换
- **状态管理**: 使用Redux管理全局状态，包括用户信息、食谱数据等

### 7.2 后端与外部服务集成

#### 7.2.1 阿里通义千问API集成
- **API配置**: 通过环境变量配置API密钥和访问地址
- **请求格式**: 构建符合千问API要求的请求格式
- **响应解析**: 解析千问API返回的非结构化内容为结构化食谱数据
- **错误处理**: 统一处理API调用异常和重试机制

### 7.3 数据传输对象 (DTOs)

```python
# schemas.py
from pydantic import BaseModel, EmailStr
from typing import List, Optional, Dict
from uuid import UUID
from datetime import datetime

# 用户相关DTO
class UserCreate(BaseModel):
    username: str
    email: EmailStr
    password: str

class UserLogin(BaseModel):
    email: EmailStr
    password: str

class UserResponse(BaseModel):
    user_id: UUID
    username: str
    email: str
    diet_preferences: Dict
    
    class Config:
        from_attributes = True

# 食谱相关DTO
class RecipeGenerateRequest(BaseModel):
    ingredients: List[str]
    restrictions: List[str]
    preferences: Optional[Dict] = None

class Ingredient(BaseModel):
    name: str
    amount: float
    unit: str

class RecipeResponse(BaseModel):
    recipe_id: UUID
    title: str
    description: Optional[str] = None
    ingredients: List[Ingredient]
    steps: List[str]
    cooking_time: Optional[int] = None
    difficulty: Optional[str] = None
    nutrition_info: Dict
    image_url: Optional[str] = None
    
    class Config:
        from_attributes = True
```

## 8. 部署与集成方案

### 8.1 开发环境配置

- **前端**: Node.js 18+, npm/yarn/pnpm
- **后端**: Python 3.10+, pip/poetry
- **数据库**: PostgreSQL 15+
- **容器化**: Docker 20+

### 8.2 配置管理

- **环境变量**: 使用.env文件管理敏感配置
- **配置文件**: 按环境分类配置文件(dev/prod/test)
- **密钥管理**: 敏感信息通过环境变量注入，不硬编码

### 8.3 目录结构

```
项目根目录/
├── frontend/                  # 前端代码
│   ├── public/                # 静态资源
│   ├── src/                   # 源代码
│   │   ├── components/        # 通用组件
│   │   ├── modules/           # 业务模块
│   │   ├── services/          # API服务
│   │   ├── store/             # Redux状态管理
│   │   └── utils/             # 工具函数
│   └── package.json           # 前端依赖
├── backend/                   # 后端代码
│   ├── app/                   # 应用代码
│   │   ├── api/               # API路由
│   │   ├── core/              # 核心配置
│   │   ├── models/            # 数据库模型
│   │   ├── schemas/           # 数据验证
│   │   └── services/          # 业务服务
│   ├── alembic/               # 数据库迁移
│   ├── main.py                # 应用入口
│   └── requirements.txt       # 后端依赖
├── docker-compose.yml         # Docker配置
└── README.md                  # 项目说明
```

## 9. 安全设计

### 9.1 认证与授权
- **JWT认证**: 使用JWT进行用户身份认证
- **密码加密**: 使用bcrypt对用户密码进行加密存储
- **权限控制**: 实现基于角色的访问控制(RBAC)

### 9.2 数据安全
- **输入验证**: 使用Pydantic进行请求数据验证
- **SQL注入防护**: 使用ORM避免SQL注入
- **敏感信息保护**: 避免在日志中记录敏感信息

### 9.3 API安全
- **CORS配置**: 合理配置跨域资源共享策略
- **请求限流**: 实现API请求频率限制，防止DoS攻击
- **HTTPS**: 生产环境使用HTTPS加密传输

## 10. 性能优化

### 10.1 前端性能
- **代码分割**: 使用动态导入实现代码分割
- **懒加载**: 实现图片和组件的懒加载
- **缓存策略**: 合理使用浏览器缓存

### 10.2 后端性能
- **异步处理**: 利用FastAPI的异步特性处理请求
- **连接池**: 使用数据库连接池优化数据库访问
- **缓存**: 对频繁访问的数据实现缓存

### 10.3 数据库性能
- **索引优化**: 为查询频繁的字段创建索引
- **查询优化**: 优化SQL查询，避免全表扫描
- **分页查询**: 实现高效的分页查询

---

**文档版本**: v1.0
**编制日期**: 2025年
**项目负责人**: 
**团队成员**: