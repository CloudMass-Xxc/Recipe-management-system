# 个性化食谱管理系统 - 数据库设计文档

## 1. 文档概述

### 1.1 文档目的
本文档详细描述个性化食谱管理系统的数据库设计，包括数据库结构、实体关系、表设计、索引设计等内容，为开发团队提供数据库实现的技术指导。

### 1.2 术语定义
- **ORM**: 对象关系映射，用于在编程语言和数据库之间建立映射关系
- **UUID**: 通用唯一识别码，用于生成表的主键
- **外键**: 用于建立表之间的关联关系
- **索引**: 提高数据库查询性能的结构
- **约束**: 确保数据完整性的规则
- **JSON字段**: PostgreSQL中存储非结构化数据的字段类型

## 2. 数据库系统选型

### 2.1 数据库选择
- **数据库类型**: PostgreSQL 14
- **选择理由**:
  - 支持JSON字段类型，适合存储食谱中的复杂数据结构
  - 强大的索引功能，支持全文搜索
  - 良好的并发性能和数据完整性保证
  - 开源且社区活跃，文档完善
  - 支持复杂查询和事务处理

### 2.2 ORM框架
- **ORM框架**: Prisma
- **选择理由**:
  - 类型安全的查询构建器
  - 自动生成TypeScript类型定义
  - 优秀的迁移工具
  - 直观的Schema定义语法
  - 良好的性能优化

## 3. 实体关系图 (ERD)

```
+----------------+       +----------------+       +----------------+
|     users      |       |    recipes     |       |  ingredients   |
+----------------+       +----------------+       +----------------+
| user_id (PK)   |<------| recipe_id (PK) |<------| ingredient_id  |
| username       |       | title          |       | name           |
| email          |       | description    |       | category       |
| password_hash  |       | ingredients    |<------| unit           |
| diet_preferences|      | steps          |       | nutrition_data |
| is_active      |       | cooking_time   |       +----------------+
| created_at     |       | difficulty     |                |
| updated_at     |       | nutrition_info |                |
+----------------+       | image_url      |                |
        |                | tags           |                |
        |                | created_at     |                |
        |                | updated_at     |                |
        |                +----------------+                |
        |                       |                         |
        |                       |                         |
        |                       v                         |
+----------------+       +----------------+                |
|   favorites    |       |    ratings     |                |
+----------------+       +----------------+                |
| favorite_id (PK)|      | rating_id (PK) |                |
| user_id (FK)   |      | user_id (FK)   |                |
| recipe_id (FK) |      | recipe_id (FK) |                |
| created_at     |      | score          |                |
+----------------+      | comment        |                |
        |               | created_at     |                |
        |               +----------------+                |
        |                       |                         |
        |                       |                         |
        v                       v                         v
+----------------+       +----------------+      +----------------+
|   diet_plans   |       | nutrition_info |      | recipe_ingredients|
+----------------+       +----------------+      +----------------+
| plan_id (PK)   |       | nutrition_id (PK)|     | recipe_id (FK) |
| user_id (FK)   |       | calories       |     | ingredient_id  |
| name           |       | protein        |     | quantity       |
| start_date     |       | carbs          |     | unit           |
| end_date       |       | fat            |     +----------------+
| recipes        |       | fiber          |
| created_at     |       | vitamins       |
| updated_at     |       +----------------+
+----------------+
```

## 4. 数据库表结构设计

### 4.1 users 表

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `user_id` | `UUID` | `PRIMARY KEY DEFAULT uuid_generate_v4()` | 用户ID |
| `username` | `VARCHAR(100)` | `UNIQUE NOT NULL INDEX` | 用户名 |
| `email` | `VARCHAR(255)` | `UNIQUE NOT NULL INDEX` | 邮箱 |
| `password_hash` | `VARCHAR(255)` | `NOT NULL` | 密码哈希值 |
| `diet_preferences` | `JSONB` | `DEFAULT '{}'` | 饮食偏好（JSON格式） |
| `is_active` | `VARCHAR(1)` | `DEFAULT 'Y'` | 是否激活 |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT NOW()` | 创建时间 |
| `updated_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT NOW() ON UPDATE NOW()` | 更新时间 |

### 4.2 recipes 表

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `recipe_id` | `UUID` | `PRIMARY KEY DEFAULT uuid_generate_v4()` | 食谱ID |
| `title` | `VARCHAR(255)` | `NOT NULL INDEX` | 食谱标题 |
| `description` | `TEXT` | | 食谱描述 |
| `ingredients` | `JSONB` | `NOT NULL` | 食材列表（JSON格式） |
| `steps` | `JSONB` | `NOT NULL` | 烹饪步骤（JSON格式） |
| `cooking_time` | `INTEGER` | | 烹饪时间（分钟） |
| `difficulty` | `VARCHAR(50)` | | 难度等级 |
| `nutrition_info` | `JSONB` | | 营养信息（JSON格式） |
| `image_url` | `VARCHAR(500)` | | 食谱图片URL |
| `tags` | `JSONB` | `DEFAULT '[]'` | 标签列表（JSON格式） |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT NOW()` | 创建时间 |
| `updated_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT NOW() ON UPDATE NOW()` | 更新时间 |

### 4.3 ingredients 表

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `ingredient_id` | `SERIAL` | `PRIMARY KEY` | 食材ID |
| `name` | `VARCHAR(255)` | `NOT NULL INDEX` | 食材名称 |
| `category` | `VARCHAR(100)` | `INDEX` | 食材分类 |
| `unit` | `VARCHAR(50)` | | 计量单位 |
| `nutrition_data` | `JSONB` | `DEFAULT '{}'` | 营养数据（JSON格式） |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT NOW()` | 创建时间 |

### 4.4 recipe_ingredients 表

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `SERIAL` | `PRIMARY KEY` | 主键ID |
| `recipe_id` | `UUID` | `NOT NULL REFERENCES recipes(recipe_id) ON DELETE CASCADE INDEX` | 食谱ID |
| `ingredient_id` | `INTEGER` | `NOT NULL REFERENCES ingredients(ingredient_id) INDEX` | 食材ID |
| `quantity` | `DECIMAL(10,2)` | `NOT NULL` | 数量 |
| `unit` | `VARCHAR(50)` | `NOT NULL` | 单位 |

### 4.5 favorites 表

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `favorite_id` | `UUID` | `PRIMARY KEY DEFAULT uuid_generate_v4()` | 收藏ID |
| `user_id` | `UUID` | `NOT NULL REFERENCES users(user_id) ON DELETE CASCADE INDEX` | 用户ID |
| `recipe_id` | `UUID` | `NOT NULL REFERENCES recipes(recipe_id) ON DELETE CASCADE INDEX` | 食谱ID |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT NOW()` | 创建时间 |

### 4.6 ratings 表

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `rating_id` | `UUID` | `PRIMARY KEY DEFAULT uuid_generate_v4()` | 评分ID |
| `user_id` | `UUID` | `NOT NULL REFERENCES users(user_id) ON DELETE CASCADE INDEX` | 用户ID |
| `recipe_id` | `UUID` | `NOT NULL REFERENCES recipes(recipe_id) ON DELETE CASCADE INDEX` | 食谱ID |
| `score` | `INTEGER` | `NOT NULL CHECK (score >= 1 AND score <= 5)` | 评分（1-5） |
| `comment` | `TEXT` | | 评论内容 |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT NOW()` | 创建时间 |

### 4.7 nutrition_info 表

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `nutrition_id` | `SERIAL` | `PRIMARY KEY` | 营养信息ID |
| `calories` | `DECIMAL(10,2)` | | 卡路里（千卡） |
| `protein` | `DECIMAL(10,2)` | | 蛋白质（克） |
| `carbs` | `DECIMAL(10,2)` | | 碳水化合物（克） |
| `fat` | `DECIMAL(10,2)` | | 脂肪（克） |
| `fiber` | `DECIMAL(10,2)` | | 膳食纤维（克） |
| `vitamins` | `JSONB` | `DEFAULT '{}'` | 维生素数据（JSON格式） |
| `minerals` | `JSONB` | `DEFAULT '{}'` | 矿物质数据（JSON格式） |

### 4.8 diet_plans 表

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `plan_id` | `UUID` | `PRIMARY KEY DEFAULT uuid_generate_v4()` | 饮食计划ID |
| `user_id` | `UUID` | `NOT NULL REFERENCES users(user_id) ON DELETE CASCADE INDEX` | 用户ID |
| `name` | `VARCHAR(255)` | `NOT NULL` | 计划名称 |
| `start_date` | `DATE` | `NOT NULL` | 开始日期 |
| `end_date` | `DATE` | `NOT NULL` | 结束日期 |
| `recipes` | `JSONB` | `DEFAULT '[]'` | 计划中的食谱（JSON格式） |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT NOW()` | 创建时间 |
| `updated_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT NOW() ON UPDATE NOW()` | 更新时间 |

## 5. 索引设计

### 5.1 主键索引
所有表的主键字段已自动创建索引，确保唯一标识和快速查找。

### 5.2 外键索引
为所有外键字段创建索引，提高连接查询性能：
- `favorites.user_id`
- `favorites.recipe_id`
- `ratings.user_id`
- `ratings.recipe_id`
- `diet_plans.user_id`
- `recipe_ingredients.recipe_id`
- `recipe_ingredients.ingredient_id`

### 5.3 全文搜索索引
```sql
-- 为食谱标题和描述创建全文搜索索引
CREATE INDEX idx_recipes_search ON recipes USING gin(to_tsvector('chinese', title || ' ' || description));

-- 为食材名称创建全文搜索索引
CREATE INDEX idx_ingredients_search ON ingredients USING gin(to_tsvector('chinese', name));
```

### 5.4 JSON字段索引
```sql
-- 为食谱标签创建GIN索引
CREATE INDEX idx_recipes_tags ON recipes USING gin(tags);

-- 为用户饮食偏好创建GIN索引
CREATE INDEX idx_users_preferences ON users USING gin(diet_preferences);
```

### 5.5 复合索引
```sql
-- 确保用户对同一食谱只能有一个收藏
CREATE UNIQUE INDEX idx_favorites_user_recipe ON favorites(user_id, recipe_id);

-- 确保用户对同一食谱只能有一个评分
CREATE UNIQUE INDEX idx_ratings_user_recipe ON ratings(user_id, recipe_id);

-- 为食谱查询优化创建复合索引
CREATE INDEX idx_recipes_difficulty_time ON recipes(difficulty, cooking_time);
```

## 6. 完整性约束设计

### 6.1 主键约束
- 所有表都有主键字段，确保记录的唯一性
- 使用UUID作为主要实体的主键，SERIAL作为关联表的主键

### 6.2 外键约束
- 所有关联表都设置了适当的外键约束
- 使用`ON DELETE CASCADE`确保数据一致性，当主表记录删除时，关联表记录也会被删除

### 6.3 唯一性约束
- `users.email`和`users.username`设置为唯一，防止重复注册
- `favorites`和`ratings`表上设置复合唯一约束，确保用户对同一食谱只能有一条收藏或评分记录

### 6.4 检查约束
- `ratings.score`设置检查约束，确保评分在1-5之间
- `users.is_active`限制为'Y'或'N'

### 6.5 非空约束
- 所有必需字段都设置了非空约束
- 适当设置默认值，确保数据完整性

## 7. 数据库迁移策略

### 7.1 使用Prisma进行数据库迁移

**schema.prisma文件示例**：

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id           String    @id @default(uuid()) @db.Uuid
  username          String    @unique @db.VarChar(100)
  email             String    @unique @db.VarChar(255)
  password_hash     String    @db.VarChar(255)
  diet_preferences  Json?     @default({})
  is_active         String    @default("Y") @db.Char(1)
  created_at        DateTime  @default(now()) @db.Timestamptz
  updated_at        DateTime  @default(now()) @updatedAt @db.Timestamptz
  favorites         Favorite[]
  ratings           Rating[]
  diet_plans        DietPlan[]
}

model Recipe {
  recipe_id        String        @id @default(uuid()) @db.Uuid
  title            String        @db.VarChar(255)
  description      String?       @db.Text
  ingredients      Json          @default([])
  steps            Json          @default([])
  cooking_time     Int?
  difficulty       String?       @db.VarChar(50)
  nutrition_info   Json?         @default({})
  image_url        String?       @db.VarChar(500)
  tags             Json          @default([])
  created_at       DateTime      @default(now()) @db.Timestamptz
  updated_at       DateTime      @default(now()) @updatedAt @db.Timestamptz
  favorites        Favorite[]
  ratings          Rating[]
  recipe_ingredients RecipeIngredient[]
}

// 其他模型定义...
```

### 7.2 迁移命令

```bash
# 生成新的迁移文件
npx prisma migrate dev --name init

# 应用迁移到数据库
npx prisma migrate deploy

# 生成Prisma客户端
npx prisma generate
```

### 7.3 迁移最佳实践
- 每个功能变更创建单独的迁移文件
- 迁移前备份数据库
- 在开发环境测试迁移
- 记录迁移历史和回滚计划

## 8. 性能优化设计

### 8.1 查询优化
- 为常用查询路径创建适当的索引
- 使用JSONB类型存储半结构化数据，减少表连接
- 对大结果集使用分页查询
- 避免全表扫描和低效查询

### 8.2 连接池配置
```typescript
// src/config/db.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
  pool: {
    min: 2,
    max: 10,
  },
});

export default prisma;
```

### 8.3 缓存策略
- 使用Redis缓存热点数据，如热门食谱、用户偏好
- 缓存频繁访问的查询结果
- 实现缓存失效机制

### 8.4 分区表策略
- 随着数据量增长，考虑对`recipes`表按时间或类别进行分区
- 对`ratings`和`favorites`表考虑按用户ID分区

### 8.5 监控与调优
- 设置慢查询日志
- 定期分析数据库性能
- 使用EXPLAIN分析查询计划

## 9. 数据安全设计

### 9.1 密码安全
- 使用bcrypt哈希存储密码，不存储明文密码
- 设置合理的密码复杂度要求

### 9.2 数据加密
- 敏感字段考虑使用PostgreSQL的加密功能
- 传输层使用SSL加密

### 9.3 访问控制
- 实现基于角色的访问控制
- 数据库用户权限最小化原则
- 使用参数化查询防止SQL注入

### 9.4 备份策略
- 定期全量备份
- 设置增量备份
- 测试备份恢复流程

## 10. 数据库扩展设计

### 10.1 读写分离
- 随着流量增长，考虑实现读写分离
- 主库负责写操作，从库负责读操作

### 10.2 分库分表
- 当单库数据量过大时，考虑按用户ID或食谱类别进行分库分表

### 10.3 NoSQL集成
- 考虑引入MongoDB存储非结构化的食谱数据或用户行为日志
- 使用Redis存储缓存数据和会话信息

## 11. 总结

本文档详细设计了个性化食谱管理系统的数据库结构，包括表设计、索引设计、约束设计、迁移策略和性能优化考虑。数据库采用PostgreSQL作为主数据库，结合Prisma ORM进行开发，支持JSON数据类型存储复杂的食谱和营养信息。

设计考虑了系统的功能需求、性能要求和安全性，为开发团队提供了清晰的数据库实现指导。通过合理的索引设计和查询优化，可以确保系统在大数据量下仍保持良好的性能。同时，完善的数据安全和备份策略，保障了系统的稳定性和数据的安全性。

随着系统的发展和数据量的增长，可以根据实际运行情况，进一步优化数据库设计，实现更高效的数据存储和访问。